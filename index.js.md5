/**
 * CatPawOpen → TVBox 最小可用桥接模板
 * 目标：
 * - iOS CatPawOpen 可加载
 * - 直接消费你现有的 TVBox subscription API
 * - 不做解析花活，先跑通
 */

const TVBOX_API = "http://183.3.135.122:3366/api/tvbox/subscription?token=erRfGFwu14RL5UKtDe9WD1zccnV5DhSr";
const USE_HTTPS = false;

/* ================= 工具函数 ================= */

async function fetchJson(url) {
  const res = await request(url, {
    headers: {
      "User-Agent": "Mozilla/5.0",
    },
  });
  return JSON.parse(res);
}

/* ================= CatPawOpen 接口 ================= */

async function init() {
  return {};
}

async function home() {
  // TVBox 通常在 home 返回 class
  const data = await fetchJson(TVBOX_API);

  return {
    class: (data.class || []).map(c => ({
      type_id: c.type_id || c.typeId || c.id,
      type_name: c.type_name || c.typeName || c.name,
    })),
  };
}

async function category(inReq) {
  const tid = inReq.body.id;
  const page = parseInt(inReq.body.page || 1);

  // TVBox 分类接口一般是 ?t=分类ID&pg=页码
  const url = `${TVBOX_API}&t=${encodeURIComponent(tid)}&pg=${page}`;
  const data = await fetchJson(url);

  return {
    page,
    pagecount: data.pagecount || 1,
    list: (data.list || []).map(v => ({
      vod_id: v.vod_id || v.id,
      vod_name: v.vod_name || v.name,
      vod_pic: v.vod_pic || v.pic || "",
      vod_remarks: v.vod_remarks || v.remarks || "",
    })),
  };
}

async function detail(inReq) {
  const id = inReq.body.id;

  // TVBox 详情一般是 ?ids=xxx
  const url = `${TVBOX_API}&ids=${encodeURIComponent(id)}`;
  const data = await fetchJson(url);

  const vod = (data.list || [])[0];
  if (!vod) return { list: [] };

  return {
    list: [
      {
        vod_id: vod.vod_id || vod.id,
        vod_name: vod.vod_name || vod.name,
        vod_pic: vod.vod_pic || "",
        vod_content: vod.vod_content || "",
        vod_play_from: vod.vod_play_
